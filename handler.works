import boto3
import json
import os
import traceback

def handler(event, context):
    print("🔍 Lambda started executing")

    try:
        secret_id = os.environ.get("SECRET_ID", "ecommerce-db-credentials")
        print("🔐 SECRET_ID:", secret_id)

        print("📡 Initializing client…")
        client = boto3.client(
            "secretsmanager",
            region_name="us-east-1",
            endpoint_url = f"http://{os.environ.get('LOCALSTACK_HOST', '127.0.0.1')}:4566"
        )

        print("📦 Fetching secret…")
        response = client.get_secret_value(SecretId=secret_id)
        print("📨 Secret fetched:", response)

        secret_string = response.get("SecretString")
        print("🧪 SecretString:", secret_string)

        secret = json.loads(secret_string)
        print("👤 Username:", secret.get("username"))

        return {
            "statusCode": 200,
            "body": f"👋 Hello from {secret.get('username', 'unknown')}'s secure Lambda!"
        }

    except Exception as e:
        print("🔥 Exception during Lambda execution:", str(e))
        traceback.print_exc()
        return {
            "statusCode": 500,
            "body": f"Internal error: {str(e)}"
        }


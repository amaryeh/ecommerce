import boto3
import json
import os
import traceback

def handler(event, context):
    print("ğŸ” Lambda started executing")

    try:
        secret_id = os.environ.get("SECRET_ID", "ecommerce-db-credentials")
        print("ğŸ” SECRET_ID:", secret_id)

        print("ğŸ“¡ Initializing clientâ€¦")
        client = boto3.client(
            "secretsmanager",
            region_name="us-east-1",
            endpoint_url = f"http://{os.environ.get('LOCALSTACK_HOST', '127.0.0.1')}:4566"
        )

        print("ğŸ“¦ Fetching secretâ€¦")
        response = client.get_secret_value(SecretId=secret_id)
        print("ğŸ“¨ Secret fetched:", response)

        secret_string = response.get("SecretString")
        print("ğŸ§ª SecretString:", secret_string)

        secret = json.loads(secret_string)
        print("ğŸ‘¤ Username:", secret.get("username"))

        return {
            "statusCode": 200,
            "body": f"ğŸ‘‹ Hello from {secret.get('username', 'unknown')}'s secure Lambda!"
        }

    except Exception as e:
        print("ğŸ”¥ Exception during Lambda execution:", str(e))
        traceback.print_exc()
        return {
            "statusCode": 500,
            "body": f"Internal error: {str(e)}"
        }

